services:
  # PostgreSQL Database: Replaces SQLite for production-grade concurrency and performance.
  postgres:
    image: postgres:15
    restart: always
    environment:
      POSTGRES_USER: town_council
      POSTGRES_PASSWORD: secure_dev_password
      POSTGRES_DB: town_council_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # Service for running the Scrapy spiders
  crawler:
    build: .
    volumes:
      - .:/app
    working_dir: /app/council_crawler
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
      - DATABASE_URL=postgresql://town_council:secure_dev_password@postgres:5432/town_council_db
      - DATA_DIR=/app/data
    depends_on:
      - postgres

  # Service for running the downloader pipeline
  pipeline:
    build: .
    volumes:
      - .:/app
    working_dir: /app/pipeline
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
      - DATABASE_URL=postgresql://town_council:secure_dev_password@postgres:5432/town_council_db
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - DATA_DIR=/app/data
    depends_on:
      - postgres

  # Apache Tika Server for high-performance text extraction and OCR.
  tika:
    image: apache/tika:latest-full
    restart: always

  # Service for extracting text from downloaded documents.
  extractor:
    build: .
    volumes:
      - .:/app
    working_dir: /app/pipeline
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
      - TIKA_SERVER_ENDPOINT=http://tika:9998
      - DATABASE_URL=postgresql://town_council:secure_dev_password@postgres:5432/town_council_db
      - DATA_DIR=/app/data
    depends_on:
      - tika
      - postgres

  # AI Summarizer: Uses Google Gemini API to summarize meeting minutes.
  summarizer:
    build: .
    volumes:
      - .:/app
    working_dir: /app/pipeline
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
      - DATABASE_URL=postgresql://town_council:secure_dev_password@postgres:5432/town_council_db
      - GEMINI_API_KEY=${GEMINI_API_KEY} # Injected from host environment
      - DATA_DIR=/app/data
    depends_on:
      - postgres

  # NLP Worker: Uses SpaCy to extract Organizations and Locations from text.
  nlp:
    build: .
    volumes:
      - .:/app
    working_dir: /app/pipeline
    command: python nlp_worker.py
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
      - DATABASE_URL=postgresql://town_council:secure_dev_password@postgres:5432/town_council_db
      - DATA_DIR=/app/data
    depends_on:
      - postgres

  # Table Worker: Uses Camelot to extract structured tables from PDFs.
  tables:
    build: .
    volumes:
      - .:/app
    working_dir: /app/pipeline
    command: python table_worker.py
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
      - DATABASE_URL=postgresql://town_council:secure_dev_password@postgres:5432/town_council_db
      - DATA_DIR=/app/data
    depends_on:
      - postgres

  # Topic Modeler: Uses LDA to discover themes across all meeting minutes.
  topics:
    build: .
    volumes:
      - .:/app
    working_dir: /app/pipeline
    command: python topic_worker.py
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
      - DATABASE_URL=postgresql://town_council:secure_dev_password@postgres:5432/town_council_db
      - DATA_DIR=/app/data
    depends_on:
      - postgres

  # Meilisearch: A fast, typo-tolerant search engine (FOSS).
  meilisearch:
    image: getmeili/meilisearch:v1.6
    ports:
      - "7700:7700"
    environment:
      - MEILI_MASTER_KEY=masterKey
    volumes:
      - meili_data:/meili_data

  # FastAPI Backend: Serves the search API and data to users.
  api:
    build: .
    volumes:
      - .:/app
    working_dir: /app/api
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload
    ports:
      - "8000:8000"
    environment:
      - MEILI_HOST=http://meilisearch:7700
      - MEILI_MASTER_KEY=masterKey
      - DATABASE_URL=postgresql://town_council:secure_dev_password@postgres:5432/town_council_db
      - PYTHONPATH=/app
    depends_on:
      - meilisearch
      - postgres

  # Next.js Frontend: The user interface for searching and viewing results.
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000
    depends_on:
      - api

  # Prometheus: FOSS monitoring system and time series database.
  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"

  # Grafana: FOSS analytics and interactive visualization web application.
  grafana:
    image: grafana/grafana:latest
    volumes:
      - grafana_data:/var/lib/grafana
    ports:
      - "3001:3000" # Mapped to 3001 to avoid conflict with frontend
    depends_on:
      - prometheus

  # Monitor: Custom Python service to export application metrics to Prometheus.
  monitor:
    build: .
    volumes:
      - .:/app
    working_dir: /app/pipeline
    command: python monitor.py
    environment:
      - PYTHONUNBUFFERED=1
      - DATABASE_URL=postgresql://town_council:secure_dev_password@postgres:5432/town_council_db
      - PYTHONPATH=/app
    depends_on:
      - postgres

volumes:
  # Persistent data storage for the SQLite DB and downloaded PDFs
  data:
  # Persistent storage for the search index
  meili_data:
  # Persistent storage for the Postgres database
  postgres_data:
  # Persistent storage for monitoring data
  prometheus_data:
  grafana_data:
